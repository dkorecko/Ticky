@page "/boards/{Id:int}/{CardId:int?}"
@using System.Security.Cryptography
@inject NavigationManager _navigationManager
@inject IDbContextFactory<DataContext> _dbContextFactory
@inject ProtectedLocalStorage _protectedLocalStorage
@inject IJSRuntime _js
@inject ILogger<BoardView> _logger
@inject IHttpContextAccessor _httpContextAccessor
@inherits NotifiableBase

@if (_board is not null)
{
    <PageTitle>
        @_board.Name - @Constants.APP_NAME
    </PageTitle>
}

<CreateColumnModal @ref="_createColumnModal" OnSubmit="async () => await RunNotification(typeof(Column), OperationType.Added)" />
<EditColumnModal @ref="_editColumnModal" OnSubmit="async () => await RunNotification(typeof(Column), OperationType.Edited)" />
<DeleteConfirmationDialog T="Column" @ref="_deleteColumnModal" OnConfirmed="HandleUpdate" />
<DeleteConfirmationDialog T="Card" @ref="_deleteTaskModal" OnConfirmed="HandleUpdate" />
<EditCardModal @ref="_editCardModal" OnSubmit="OnTaskEdited" />
<EditBoardMembershipsModal @ref="_editBoardMembershipsModal" OnSubmit="async () => await RunNotification(typeof(BoardMembership), OperationType.Edited)" />

@if(_board is null)
{
    <Spinner/>
} else
{
    <div class="relative">
        <div class="island-title flex w-full flex-row justify-between">
            <div class="flex flex-row items-center gap-4">
                <div class="rounded-button hidden h-12 w-12 bg-secondary sm:block">
                    &nbsp;
                </div>
                <div class="flex flex-col space-y-1">
                    <h5 class="w-max font-bold">@_board.Name</h5>
                    <p class="text-xs opacity-70">@_board.Project.Name</p>
                </div>
            </div>

            <div class="flex flex-row space-x-2 sm:hidden">
                @{
                    var i = 0;
                }
                @foreach (var member in _members)
                {
                    string id = $"avatar_{i}";
                    <div id="@id" class="avatar @(i > 0 ? "stack-avatars" : "") self-center" style="background-image: url('@Constants.ACCESS_UPLOADED_IMAGES_PATH/@member.ProfilePictureFileName');" @onclick="() => MainLayout.UserInfoModal?.Open(id, member.Id)"></div>
                    i++;
                }
                <VerticalSeparator />

                <div class="relative flex self-center">
                    <button @onclick=ToggleMenu class="btn-transparent btn flex self-center">
                        @if (_dropdownMenu)
                        {
                            <span class="material-symbols-rounded g-icon self-center">
                                close
                            </span>
                        }
                        else
                        {
                            <span class="material-symbols-rounded g-icon self-center">
                                menu
                            </span>
                        }
                    </button>
                    <div class="@(_dropdownMenu ? "absolute" : "hidden") top-12 right-0">
                        <div class="dropdown-box">
                            @if (IsAdmin())
                            {
                                <a href="/boards/settings/@_board.Id" class="nav-link">
                                    <span class="material-symbols-rounded g-icon self-center">
                                        settings
                                    </span>
                                    <span class="self-center">
                                        Settings
                                    </span>
                                </a>

                                <button class="nav-link" @onclick="() => _editBoardMembershipsModal?.Open(_board.Id, _board.ProjectId)" title="Add member">
                                    <span class="material-symbols-rounded g-icon self-center">
                                        add
                                    </span>
                                    <span class="self-center">
                                        Add member
                                    </span>
                                </button>
                            }
                            @{
                                var filterIcon = "filter-icon";
                            }

                            <button class="nav-link" title="Filter cards" id=@filterIcon @onclick="() => _filterCardsModal?.Open(filterIcon)">
                                <span class="relative z-0 inline-block self-center">
                                    <span class="material-symbols-rounded g-icon">
                                        tune
                                    </span>
                                    @if (_filterModel.IsAnyFilterApplied())
                                    {
                                        <span class="absolute top-1 right-2 h-2 w-2 rounded-full bg-secondary dark:bg-secondaryDark"></span>
                                    }
                                </span>
                                <span class="self-center">
                                    Filter
                                </span>
                            </button>


                            <button @onclick="SwitchStatsDisplay" title="Toggle statistics" class="nav-link">
                                <span class="material-symbols-rounded g-icon self-center">
                                    finance
                                </span>
                                <span class="self-center">
                                    Statistics
                                </span>
                            </button>

                        </div>
                    </div>
                </div>
            </div>

            <div class="hidden flex-row space-x-1 sm:flex">
                @{
                    i = 0;
                }
                @foreach (var member in _members)
                {
                    string id = $"avatar_{i}";
                    <div id="@id" class="avatar @(i > 0 ? "stack-avatars" : "") self-center" style="background-image: url('@Constants.ACCESS_UPLOADED_IMAGES_PATH/@member.ProfilePictureFileName');" @onclick="() => MainLayout.UserInfoModal?.Open(id, member.Id)"></div>
                    i++;
                }
                @if (IsAdmin())
                {
                    <button class="add btn-transparent btn flex" @onclick="() => _editBoardMembershipsModal?.Open(_board.Id, _board.ProjectId)" title="Add member">
                        <span class="material-symbols-rounded g-icon self-center">
                            add
                        </span>
                    </button>
                }
                <VerticalSeparator />

                <span class="relative z-0 inline-block self-center">
                    <button title="Filter cards" id=@filterIcon @onclick="() => _filterCardsModal?.Open(filterIcon)" class="material-symbols-rounded g-icon  btn-transparent btn flex self-center">
                        tune
                    </button>
                    @if (_filterModel.IsAnyFilterApplied())
                    {
                        <span class="absolute top-1 right-2 h-2 w-2 rounded-full bg-secondary dark:bg-secondaryDark"></span>
                    }
                </span>

                <button @onclick="SwitchStatsDisplay" title="Toggle statistics" class="material-symbols-rounded g-icon btn-transparent btn flex self-center">
                    finance
                </button>

                @if (IsAdmin())
                {
                    <a href="/boards/settings/@_board.Id" title="Board settings" class="material-symbols-rounded g-icon btn-transparent btn flex self-center">
                        settings
                    </a>
                }
            </div>
        </div>
        <FilterCardsModal @ref="_filterCardsModal" Model="_filterModel" SearchUpdated="LoadCardsAsync" BoardMembers="_members" BoardLabels="_labels" />
    </div>

    <div class="h-board-content flex w-full flex-row">
        @if (_board is not null)
        {
            <section id="board-section" class="w-full flex-row gap-2 overflow-x-auto pt-2 @(_preferences.ShowStats ? "hidden md:flex" : "flex")">
                <SortableList Class="flex flex-row gap-2" Animation=@(_board.DisableSortingAnimations ? 0 : 200) Items="_board.Columns.OrderBy(x => x.Index).ToList()" Context="column" OnUpdate="OnColumnMoved" Direction="horizontal" Handle=".drag-toggle" Pull=false Put=false>
                    <SortableItemTemplate>
                        <ColumnView @key="column.Id" Column="column" Cards="_cards" Members="_members" Board="@_board" EditColumnModal="_editColumnModal" DeleteColumnModal="_deleteColumnModal" EditCardModal="_editCardModal" DeleteCardModal="_deleteTaskModal" OnCardMoved=StateHasChanged AddingSetter=SetAdding IsAdmin="IsAdmin" AddingCardHere="(_adding == column.Id)" OnUpdate="HandleUpdate" />
                    </SortableItemTemplate>
                </SortableList>

                @if (IsAdmin())
                {
                    <button class="btn btn-purple h-min !w-80 font-bold" @onclick="() => _createColumnModal?.Open(_board.Id)" style="order: @(_board.Columns.Any() ? _board.Columns.Max(x => x.Id) + 1 : 0);" title="Add new column">
                        New column
                    </button>
                }
            </section>

            if (_preferences.ShowStats)
            {
                <section class="flex w-screen flex-col items-center gap-6 px-2 py-6 md:w-80">
                    <div class="flex w-full flex-row items-center justify-between">
                        <h1>Progress</h1>
                        <i class="fa fa-xmark -button" @onclick=SwitchStatsDisplay title="Close statistics"></i>
                    </div>
                    <div class="flex w-full flex-col gap-8">
                        <!-- Side section -->
                        @if (_board is not null)
                        {
                            var completedCards = _cards.Where(x => x.Column.Finished).Count();
                            var totalCards = _cards.Count();

                            <div class="flex flex-col gap-4">
                                <div class="flex flex-col gap-1">
                                    <div class="flex flex-row justify-between text-xs">
                                        <label>Tasks completed</label>
                                        <label class="text-gray-500">@completedCards/@totalCards</label>
                                    </div>
                                    <div class="grid h-1 w-full rounded-lg">
                                        <div class="z-10 w-24 rounded-lg bg-pink-500 transition-all" style="grid-row: 1; grid-column: 1; width: @(totalCards == 0 ? 0 : Math.Round((double)completedCards / totalCards * 100))%;"></div>
                                        <div class="rounded-lg bg-pink-300" style="grid-row: 1; grid-column: 1;"></div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <Spinner />
                        }
                    </div>
                </section>
            }
        }
        else
        {
            <Spinner />
        }
    </div>
}

@code {
    [CascadingParameter(Name = Constants.CascadingParameters.CurrentAccount)]
    private User _user { get; set; } = default!;

    [Parameter]
    public int Id { get; set; } = default!;

    [Parameter]
    public int? CardId { get; set; }

    private string FILTERS_SCOPED_KEY { get => $"{Constants.StorageKeys.FilterPreferencesPrefix}_{Id}"; }

    private Board? _board;
    private List<User> _members = [];
    private List<Card> _cards = [];
    private List<Label> _labels = [];
    private Guid _pageId = Guid.NewGuid();

    private CreateColumnModal? _createColumnModal;
    private EditColumnModal? _editColumnModal;
    private EditCardModal? _editCardModal;
    private DeleteConfirmationDialog<Column>? _deleteColumnModal;
    private DeleteConfirmationDialog<Card>? _deleteTaskModal;
    private EditBoardMembershipsModal? _editBoardMembershipsModal;
    private FilterCardsModal? _filterCardsModal;
    private List<ElementReference> _avatars = [];
    private ElementReference Avatars { set => _avatars.Add(value); }

    private bool _dropdownMenu = false;

    private int _adding;
    private BoardPreferencesModel _preferences = new();
    private FilterCardsModel _filterModel = new();
    private int? _initialCardId;

    private HubConnection? _hubConnection;

    protected override void OnParametersSet()
    {
        if (_board is null || !CardId.HasValue || _initialCardId == CardId)
            return;

        _initialCardId = CardId;
        _editCardModal?.Open(CardId.Value, _members, _board.Columns);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        var httpContext = _httpContextAccessor.HttpContext;

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(_navigationManager.ToAbsoluteUri(Constants.Hubs.UPDATE_HUB), options =>
        {
            if(httpContext?.Request.Cookies is not null)
            {
                foreach (var cookie in httpContext.Request.Cookies)
                {
                    options.Cookies.Add(new System.Net.Cookie
                    {
                        Name = cookie.Key,
                        Value = cookie.Value,
                        Domain = new Uri(_navigationManager.BaseUri).Host
                    });
                }
            }
        })
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<int, Guid>(nameof(UpdateHub.BoardChange), async (boardId, pageId) =>
        {
            if (boardId != Id || pageId == _pageId)
                return;

            await HandleRemoteUpdate();
        });

        _ = HandleConnectionAsync();

        _initialCardId = CardId;

        try
        {
            var boardPreferences = await _protectedLocalStorage.GetAsync<BoardPreferencesModel>(Constants.StorageKeys.BoardPreferences);
            _preferences = (boardPreferences.Success ? boardPreferences.Value : new()) ?? new();
        }
        catch (CryptographicException)
        {
            _preferences = new();
        }

        try
        {
            var filterPreferences = await _protectedLocalStorage.GetAsync<FilterCardsModel>(FILTERS_SCOPED_KEY);
            _filterModel = (filterPreferences.Success ? filterPreferences.Value : new()) ?? new();
        }
        catch(CryptographicException)
        {
            _filterModel = new();
        }

        await HandleUpdate();

        if (_board is null)
            return;

        using var db = _dbContextFactory.CreateDbContext();

        var user = await db.Users
            .Include(x => x.LastVisits)
            .FirstOrDefaultAsync(x => x.Id.Equals(_user.Id));

        if (user is null)
            return;

        user.LastVisitedBoardId = _board.Id;

        var pastVisit = user.LastVisits.FirstOrDefault(x => x.BoardId.Equals(_board.Id));

        if (pastVisit is not null)
            user.LastVisits.Remove(pastVisit);

        user.LastVisits.Add(new LastVisit
        {
            UserId = _user.Id,
            BoardId = _board.Id,
            VisitTime = DateTime.Now
        });

        await db.SaveChangesAsync();

        if(CardId.HasValue)
            _editCardModal?.Open(CardId.Value, _members, _board.Columns);

        await MainLayout.UpdateRecentBoard();
    }

    private async Task HandleConnectionAsync()
    {
        if(_hubConnection is null)
            return;

        try
        {
            await _hubConnection.StartAsync();
            await _hubConnection.SendAsync(nameof(UpdateHub.SubscribeBoard), Id);
        } catch(Exception ex)
        {
            _logger.LogError(ex, "Failed to start hub connection or subscribe to board {BoardId}", Id);
            MainLayout.RunNotification(new("Real-time updates unavailable. Please refresh the page.", NotificationType.Fail));
        }
    }

    private async Task SwitchStatsDisplay()
    {
        _preferences.ShowStats = !_preferences.ShowStats;

        try
        {
            await _protectedLocalStorage.SetAsync(Constants.StorageKeys.BoardPreferences, _preferences);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to save board preferences.");
        }

        StateHasChanged();
    }

    private async Task OnColumnMoved((string movedItemId, string? targetItemId, string _) args)
    {
        if(_board is null)
            return;

        var movedColumnId = Convert.ToInt32(args.movedItemId);
        var snapshot = _board.Columns.Select(c => new { c.Id, c.Index }).ToList();

        var movedColumn = _board.Columns.FirstOrDefault(x => x.Id.Equals(movedColumnId));

        if (movedColumn is null)
            return;

        int targetIndex = _board.Columns.Any() ? _board.Columns.Max(x => x.Index) + 1 : 0;
        int? targetItemId = args.targetItemId is not null ? Convert.ToInt32(args.targetItemId) : null;

        if (targetItemId.HasValue)
        {
            var targetColumn = _board.Columns.FirstOrDefault(x => x.Id.Equals(targetItemId));
            if (targetColumn is not null)
            {
                targetIndex = targetColumn.Index;
                foreach (var column in _board.Columns.OrderByDescending(x => x.Index))
                {
                    if (column.Index >= targetColumn.Index)
                        column.Index++;
                }
            }
        }

        movedColumn.Index = targetIndex;
        IndexHelper.FixIndices(_board.Columns);
        StateHasChanged();

        try
        {
            using var db = _dbContextFactory.CreateDbContext();

            var targetBoard = db.Boards
                .Include(x => x.Columns)
                .FirstOrDefault(x => x.Id.Equals(Id));

            if (targetBoard is null)
                throw new InvalidOperationException("Board not found in DB.");

            var dbMovedColumn = targetBoard.Columns.FirstOrDefault(x => x.Id.Equals(movedColumnId));
            if (dbMovedColumn is null)
                throw new InvalidOperationException("Moved column not found in DB.");

            int dbTargetIndex = targetBoard.Columns.Any() ? targetBoard.Columns.Max(x => x.Index) + 1 : 0;
            if (targetItemId.HasValue)
            {
                var dbTargetColumn = targetBoard.Columns.FirstOrDefault(x => x.Id.Equals(targetItemId));
                if (dbTargetColumn is not null)
                {
                    dbTargetIndex = dbTargetColumn.Index;
                    foreach (var column in targetBoard.Columns.OrderByDescending(x => x.Index))
                    {
                        if (column.Index >= dbTargetColumn.Index)
                            column.Index++;
                    }
                }
            }

            dbMovedColumn.Index = dbTargetIndex;
            IndexHelper.FixIndices(targetBoard.Columns);

            await db.SaveChangesAsync();
            await HandleUpdate();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to persist moved column.");

            foreach (var oldColumnPosition in snapshot)
            {
                var column = _board.Columns.FirstOrDefault(x => x.Id == oldColumnPosition.Id);
                if (column is not null)
                    column.Index = oldColumnPosition.Index;
            }

            IndexHelper.FixIndices(_board.Columns);
            StateHasChanged();

            MainLayout.RunNotification(new("Failed to move column. Changes were reverted.", NotificationType.Fail));
        }
    }

    private async Task OnDataChanged()
    {
        if(_hubConnection is null || _hubConnection.State != HubConnectionState.Connected)
            return;

        await _hubConnection.SendAsync(nameof(UpdateHub.BoardChange), Id, _pageId);
    }

    private async Task HandleRemoteUpdate()
    {
        await LoadBoardAsync();
    }

    protected override async Task HandleUpdate()
    {
        await LoadBoardAsync();
        await OnDataChanged();
    }

    private async Task LoadBoardAsync()
    {
        using var db = _dbContextFactory.CreateDbContext();

        var board = await db.Boards
            .Include(x => x.Columns)
            .Include(x => x.Labels)
            .Include(x => x.Project)
                .ThenInclude(x => x.Memberships)
                    .ThenInclude(x => x.User)
            .Include(x => x.Memberships)
                .ThenInclude(x => x.User)
            .AsNoTracking()
            .FirstOrDefaultAsync(x => x.Id.Equals(Id));

        if(board is null || !board.VerifyAccess(_user))
        {
            MainLayout.RunNotification(new("This board either does not exist or you do not have access.", NotificationType.Fail));
            _navigationManager.NavigateTo("/");
            return;
        }

        _members = [];

        if (board.Memberships.Any())
            _members.AddRange(board.Memberships.Select(x => x.User));

        if (board.Project.Memberships.Any())
            _members.AddRange(board.Project.Memberships.Select(x => x.User));

        _members = _members.DistinctBy(x => x.Id).ToList();
        _labels = board.Labels;
        _board = board;

        await LoadCardsAsync();

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadCardsAsync()
    {
        ArgumentNullException.ThrowIfNull(_board);

        using var db = _dbContextFactory.CreateDbContext();
        var columnIds = _board.Columns.Select(x => x.Id).ToList();

        var queryableCards = db.Cards
            .AsNoTracking()
            .Include(x => x.CreatedBy)
            .Include(x => x.Assignees)
            .Include(x => x.Attachments)
            .Include(x => x.Subtasks)
            .Include(x => x.Labels)
            .Include(x => x.TimeRecords)
            .Include(x => x.Column)
            .Where(x => columnIds.Contains(x.ColumnId))
            .Where(x => !x.SnoozedUntil.HasValue);

        if (_filterModel.ExcludeCompleted)
            queryableCards = queryableCards.Where(x => !x.Column.Finished);

        if(!string.IsNullOrWhiteSpace(_filterModel.Text))
        {
            var query = _filterModel.Text.Trim();
            queryableCards = queryableCards.Where(x => x.Name.Contains(query) || (x.Column.Board.Code + "-" + x.Number).Contains(query) || (x.Description != null && x.Description.Contains(query)));
        }

        if (_filterModel.AssignedUserIds.Count > 0 || _filterModel.IncludeUnassigned)
            queryableCards = queryableCards.Where(card =>
                (_filterModel.AssignedUserIds.Count > 0 && card.Assignees.Any(a => _filterModel.AssignedUserIds.Contains(a.Id)))
                || (_filterModel.IncludeUnassigned && !card.Assignees.Any())
            );

        if (_filterModel.LabelIds.Count > 0)
            queryableCards = queryableCards.Where(card => card.Labels.Any(x => _filterModel.LabelIds.Contains(x.Id)));

        _cards = await queryableCards.ToListAsync();

        await InvokeAsync(StateHasChanged);

        try
        {
            await _protectedLocalStorage.SetAsync(FILTERS_SCOPED_KEY, _filterModel);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to save filter preferences.");
        }
    }

    private bool IsAdmin()
    {
        if(_board is null)
            return false;

        var boardMembership = _board.Memberships.FirstOrDefault(x => x.UserId.Equals(_user.Id));

        if(boardMembership is null)
        {
            var projectMembership = _board.Project.Memberships.FirstOrDefault(x => x.UserId.Equals(_user.Id));

            if(projectMembership is null)
                return false;

            return projectMembership.IsAdmin;
        }

        return boardMembership.IsAdmin;
    }

    private async Task OnTaskEdited()
    {
        ArgumentNullException.ThrowIfNull(_board);

        await HandleUpdate();
    }

    private void SetAdding(int columnId)
    {
        _adding = columnId;
    }

    private void ToggleMenu()
    {
        _dropdownMenu = !_dropdownMenu;
    }
}

